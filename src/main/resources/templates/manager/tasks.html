<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Назначение заданий</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/styles.css">
    <script>
        function showReuploadMessage(message, id) {
            const el = document.getElementById('reupload-status-' + id);
            el.innerText = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function reuploadTask(taskId, inputId) {
            const input = document.getElementById(inputId);
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("taskId", taskId);
            formData.append("file", file);

            fetch('/api/tasks/reupload-task', {
                method: 'POST',
                body: formData
            })
                .then(res => res.text())
                .then(msg => showReuploadMessage(msg, taskId))
                .catch(err => showReuploadMessage("Ошибка: " + err, taskId));
        }

        function submitForm() {
            const fileInput = document.getElementById('taskFile');
            const file = fileInput.files[0];
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const selectedOptions = document.getElementById('assignedTo').selectedOptions;
            const assignedTo = Array.from(selectedOptions).map(opt => opt.value);

            if (!file || !startDate || !endDate || assignedTo.length === 0) {
                alert("Пожалуйста, заполните все поля!");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("startDate", startDate);
            formData.append("endDate", endDate);
            assignedTo.forEach(id => formData.append("assignedTo", id));

            fetch("/api/tasks/upload-task", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    location.reload();
                })
                .catch(err => alert("Ошибка: " + err));
        }
    </script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 bg-light vh-100 p-3">
            <h4>Руководитель</h4>
            <a th:href="@{/manager/tasks.html(userId=${userId})}" class="btn btn-outline-dark w-100 mb-2">Задания</a>
            <a th:href="@{/manager/reports.html(userId=${userId})}" class="btn btn-outline-dark w-100">Отчёты</a>
        </div>
        <div class="col-md-10">
            <h1 class="mt-3">Назначение заданий</h1>

            <!-- Форма назначения нового задания -->
            <form onsubmit="submitForm(); return false;" class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">Файл задания</label>
                    <input type="file" class="form-control" name="file" id="taskFile" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Дата начала</label>
                    <input type="date" class="form-control" name="startDate" id="startDate" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Дата окончания</label>
                    <input type="date" class="form-control" name="endDate" id="endDate" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Сотрудники</label>
                    <select multiple class="form-control" id="assignedTo" name="assignedTo">
                        <option th:each="user : ${users}"
                                th:value="${user.id}"
                                th:text="${user.name}">
                        </option>
                    </select>
                </div>
                <div class="col-12">
                    <button type="button" class="btn btn-success" onclick="submitForm()">Назначить задание</button>
                </div>
            </form>

            <!-- Таблица существующих заданий -->
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>Описание</th>
                    <th>Файл</th>
                    <th>Дата начала</th>
                    <th>Срок</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="task : ${tasks}">
                    <td th:text="${task.description}"></td>
                    <td>
                        <a th:href="@{'/api/tasks/download/' + ${task.filePath}}"
                           th:text="${task.filePath}"></a>
                        <form class="mt-2"
                              onsubmit="event.preventDefault(); reuploadTask([[${task.id}]], 'file-' + [[${task.id}]]);">
                            <input type="file" class="form-control mb-1" th:id="'file-' + ${task.id}" required>
                            <button type="submit" class="btn btn-sm btn-warning">Заменить файл</button>
                        </form>
                        <div class="text-info small mt-1" th:id="'reupload-status-' + ${task.id}"
                             style="display: none"></div>
                    </td>
                    <td th:text="${task.startDate}"></td>
                    <td th:text="${task.deadline}"></td>
                    <td>...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>